<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias musicales del Diario del Debate 1881-1883</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 95%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2a5298;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .main-content {
            display: flex;
            min-height: 80vh;
        }
        .left-panel {
            width: 380px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }
        .search-section {
            margin-bottom: 30px;
        }
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            border-color: #2a5298;
        }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }
        .search-icon:hover {
            color: #2a5298;
        }
        .year-selector {
            margin-bottom: 20px;
        }
        .year-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .year-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .year-btn:hover {
            background: #e9ecef;
        }
        .year-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        .year-btn.all-years, .year-btn.none-years {
            font-weight: bold;
        }
        .clear-btn {
            width: 100%;
            padding: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .clear-btn:hover {
            background: #c82333;
        }
        .stats {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-number {
            font-weight: bold;
            font-size: 1.2rem;
            color: #2a5298;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        .calendar-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .calendar-header {
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 15px;
            text-align: center;
        }
        .year-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .nav-btn {
            background: #2a5298;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .current-year-selector {
            font-weight: bold;
            color: #2a5298;
        }
        .calendar-container-annual {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .month-wrapper {
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .month-title {
            text-align: center;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 5px;
            background: #e9ecef;
            font-size: 11px;
        }
        .calendar-day {
            text-align: center;
            padding: 4px;
            cursor: pointer;
            position: relative;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            border-radius: 3px;
        }
        .calendar-day:hover {
            background: #e9ecef;
        }
        .calendar-day.has-news {
            background: #e3f2fd;
            color: #1565c0;
            font-weight: bold;
        }
        .calendar-day.has-news:hover {
            background: #bbdefb;
        }
        .calendar-day.selected {
            background: #2a5298 !important;
            color: white !important;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .news-count {
            position: absolute;
            top: -3px;
            right: -3px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        .results-section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .results-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2a5298;
        }
        .results-count {
            color: #666;
            font-size: 0.9rem;
        }
        .result-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .result-item:hover {
            transform: translateY(-2px);
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .result-date {
            font-weight: bold;
            color: #2a5298;
            font-size: 1.1rem;
        }
        .result-meta {
            color: #666;
            font-size: 0.9rem;
        }
        .news-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2a5298;
        }
        .news-item:last-child {
            margin-bottom: 0;
        }
        .news-text {
            line-height: 1.6;
            margin-bottom: 10px;
            color: #333;
        }
        .news-page {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }
        .highlight {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        .no-results h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        /* Mejoras para m√≥vil */
        @media (max-width: 1200px) {
            .calendar-container-annual {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
                border-radius: 10px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                max-width: none;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                padding: 15px;
            }
            
            .results-section {
                padding: 15px;
            }
            
            .title {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            header {
                padding: 20px;
            }
            
            .calendar-container-annual {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .month-wrapper {
                padding: 8px;
            }
            
            .result-item {
                padding: 15px;
            }
            
            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .results-title {
                font-size: 1.3rem;
            }
            
            .year-buttons {
                gap: 3px;
            }
            
            .year-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            .left-panel, .results-section {
                padding: 10px;
            }
            
            .calendar-day {
                min-height: 25px;
                font-size: 10px;
            }
            
            .news-count {
                width: 12px;
                height: 12px;
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">üìú Diario del Debate (1881-1883)</h1>
            <p class="subtitle">Buscador din√°mico de noticias musicales</p>
        </header>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando datos del archivo combined.json...</p>
        </div>
        <div id="mainContent" class="main-content" style="display: none;">
            <div class="left-panel">
                <div class="search-section">
                    <h3 style="margin-bottom: 15px; color: #2a5298;">üîç B√∫squeda en Texto Completo</h3>
                    <div class="search-box">
                        <input 
                            type="text" 
                            class="search-input" 
                            id="searchInput" 
                            placeholder="Buscar... (√≥pera, teatro, m√∫sica - busca con/sin acentos, may√∫s/min√∫s)"
                            autocomplete="off"
                        >
                        <span class="search-icon" id="searchButton" title="Hacer b√∫squeda">üîç</span>
                    </div>
                    <div class="year-selector">
                        <h4 style="margin-bottom: 10px; color: #2a5298;">üìÖ Filtrar por A√±o</h4>
                        <div class="year-buttons" id="yearButtons">
                            </div>
                    </div>
                    <div class="filters" id="filters">
                        <button class="clear-btn" onclick="clearSearch()">Limpiar Todo</button>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-number" id="totalDays">0</span>
                            <span class="stat-label">D√≠as con noticias</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="totalNews">0</span>
                            <span class="stat-label">Noticias totales</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="filteredDays">0</span>
                            <span class="stat-label">D√≠as mostrados</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="filteredNews">0</span>
                            <span class="stat-label">Noticias mostradas</span>
                        </div>
                    </div>
                </div>
                <div class="calendar-section">
                    <div class="calendar-header" id="calendarHeader">Calendario Anual</div>
                    <div class="year-navigation">
                        <button class="nav-btn" id="prevYearBtn" onclick="changeYear(-1)">‚Äπ</button>
                        <div class="current-year-selector" id="currentYearSelector"></div>
                        <button class="nav-btn" id="nextYearBtn" onclick="changeYear(1)">‚Ä∫</button>
                    </div>
                    <div id="calendarContainer">
                        </div>
                </div>
            </div>
            <div class="results-section">
                <div class="results-header">
                    <div class="results-title" id="resultsTitle">Todas las Noticias</div>
                    <div class="results-count" id="resultsCount">Cargando...</div>
                </div>
                <div id="results"></div>
            </div>
        </div>
    </div>

<script>
let allData = [];
let currentResults = [];
let selectedDay = null;
let searchTerm = '';
let selectedYears = [];
let currentCalendarYear = null;
let availableYears = [];

document.addEventListener('DOMContentLoaded', loadData);

async function loadData() {
    try {
        console.log('Intentando cargar combined.json...');
        const response = await fetch('combined.json');
        
        console.log('Respuesta fetch:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
        }
        
        const jsonData = await response.json();
        console.log('Datos JSON cargados:', jsonData);
        console.log('Tipo de datos:', typeof jsonData);
        console.log('Es array:', Array.isArray(jsonData));
        console.log('N√∫mero de elementos:', jsonData?.length);
        
        if (!jsonData || !Array.isArray(jsonData) || jsonData.length === 0) {
            throw new Error('El archivo combined.json est√° vac√≠o o no tiene el formato correcto');
        }
        
        allData = jsonData;
        console.log('Datos asignados correctamente');
        console.log('Estructura del primer elemento:', JSON.stringify(allData[0], null, 2));
        
        // Si es un objeto en lugar de array, convertirlo
        if (!Array.isArray(allData)) {
            console.log('Los datos no son un array, intentando convertir...');
            if (typeof allData === 'object') {
                // Si es un objeto con propiedades que son arrays
                const possibleArrays = Object.values(allData).filter(val => Array.isArray(val));
                if (possibleArrays.length > 0) {
                    allData = possibleArrays[0];
                    console.log('Convertido a array:', allData.length, 'elementos');
                } else {
                    // Si es un objeto √∫nico, ponerlo en un array
                    allData = [allData];
                    console.log('Objeto √∫nico convertido a array');
                }
            }
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').style.display = 'flex';
        initializeApp();
        
    } catch (error) {
        console.error('Error detallado al cargar combined.json:', error);
        document.getElementById('loading').innerHTML = `
            <div style="color: #dc3545; text-align: center;">
                <h3>‚ùå Error al cargar el archivo</h3>
                <p>No se pudo cargar 'combined.json'.</p>
                <div style="background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; text-align: left;">
                    <strong>Detalles t√©cnicos:</strong><br>
                    <code style="color: #dc3545;">${error.message}</code><br><br>
                    <strong>Posibles causas:</strong><br>
                    ‚Ä¢ El archivo 'combined.json' no est√° en la misma carpeta<br>
                    ‚Ä¢ El archivo tiene un formato JSON inv√°lido<br>
                    ‚Ä¢ Problemas de permisos del servidor<br>
                    ‚Ä¢ El archivo est√° vac√≠o
                </div>
                <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #2a5298; color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Reintentar</button>
            </div>`;
    }
}

function initializeApp() {
    console.log('Inicializando aplicaci√≥n con datos:', allData);
    
    try {
        // Extraer a√±os de los nombres de archivos PDF (tu estructura tiene "A√±o": "D√≠ario del debate")
        const yearSet = new Set();
        
        allData.forEach(item => {
            console.log('Procesando item:', item);
            
            // Tu estructura tiene ejemplares directamente
            if (item.ejemplares && Array.isArray(item.ejemplares)) {
                console.log('Encontrados ejemplares:', item.ejemplares.length);
                
                item.ejemplares.forEach(ejemplar => {
                    if (ejemplar.PDF) {
                        const match = ejemplar.PDF.match(/(\d{4})-\d{2}-\d{2}\.pdf$/);
                        if (match) {
                            const year = parseInt(match[1]);
                            yearSet.add(year);
                            console.log('A√±o extra√≠do del PDF:', year, 'desde', ejemplar.PDF);
                        }
                    }
                });
            }
        });
        
        availableYears = Array.from(yearSet).sort((a, b) => a - b);
        console.log('A√±os disponibles extra√≠dos:', availableYears);
        
        if (availableYears.length === 0) {
            throw new Error('No se pudieron extraer a√±os v√°lidos de los datos');
        }
        
        // Reorganizar datos por a√±o usando los a√±os extra√≠dos de los PDFs
        reorganizeDataByYear();
        
        // Por defecto, todos los a√±os est√°n seleccionados
        selectedYears = [...availableYears];
        currentCalendarYear = availableYears[0];
        
        generateYearButtons();
        generateCalendar();
        
        // Cargar TODAS las noticias por defecto
        loadAllNews();
        setupEventListeners();
        
        console.log('Aplicaci√≥n inicializada correctamente');
        console.log('A√±os seleccionados al inicio:', selectedYears);
    } catch (error) {
        console.error('Error al inicializar la aplicaci√≥n:', error);
        document.getElementById('loading').innerHTML = `
            <div style="color: #dc3545; text-align: center;">
                <h3>‚ùå Error al procesar los datos</h3>
                <p>Los datos se cargaron pero tienen un formato incorrecto.</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">Error: ${error.message}</p>
                <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #2a5298; color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Reintentar</button>
            </div>`;
    }
}

function setupEventListeners() {
    // Event listener para el bot√≥n de b√∫squeda
    document.getElementById('searchButton').addEventListener('click', executeSearch);
    
    // Event listener para la tecla Enter en el input de b√∫squeda
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            executeSearch();
        }
    });
    
    // Event listener para b√∫squeda en tiempo real (opcional)
    document.getElementById('searchInput').addEventListener('input', (e) => {
        // Opcional: b√∫squeda en tiempo real con debounce
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
            executeSearch();
        }, 300);
    });
}

function executeSearch() {
    searchTerm = document.getElementById('searchInput').value;
    
    // Limpiar selecci√≥n de d√≠a al hacer b√∫squeda
    selectedDay = null;
    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
    
    // Si no hay t√©rmino de b√∫squeda y todos los a√±os est√°n seleccionados, mostrar todas las noticias
    if (!searchTerm.trim() && selectedYears.length === availableYears.length) {
        loadAllNews();
    } else {
        performSearch();
    }
}

function generateYearButtons() {
    const yearButtonsContainer = document.getElementById('yearButtons');
    yearButtonsContainer.innerHTML = '';
    
    // Bot√≥n "Todos"
    const allBtn = document.createElement('button');
    allBtn.className = 'year-btn all-years active';
    allBtn.textContent = 'Todos';
    allBtn.onclick = () => selectAllYears();
    yearButtonsContainer.appendChild(allBtn);
    
    // Bot√≥n "Ninguno"
    const noneBtn = document.createElement('button');
    noneBtn.className = 'year-btn none-years';
    noneBtn.textContent = 'Ninguno';
    noneBtn.id = 'none-btn';
    noneBtn.onclick = () => selectNoYears();
    yearButtonsContainer.appendChild(noneBtn);
    
    // Botones para cada a√±o
    availableYears.forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'year-btn active';
        btn.textContent = year;
        btn.id = `year-${year}`;
        btn.onclick = () => toggleYear(year);
        yearButtonsContainer.appendChild(btn);
    });
}

function selectAllYears() {
    console.log('Seleccionando todos los a√±os');
    selectedYears = [...availableYears];
    
    // Limpiar b√∫squeda y selecci√≥n de d√≠a para mostrar TODO
    searchTerm = '';
    selectedDay = null;
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
    
    updateYearButtons();
    updateCalendarForSelectedYears();
    
    // Cargar todas las noticias
    loadAllNews();
    
    console.log('Todos los a√±os seleccionados:', selectedYears);
}

function selectNoYears() {
    selectedYears = [];
    updateYearButtons();
    updateCalendarForSelectedYears();
    
    // Limpiar resultados cuando no hay a√±os seleccionados
    currentResults = [];
    displayResults();
    updateStats();
}

function toggleYear(year) {
    const index = selectedYears.indexOf(year);
    if (index > -1) selectedYears.splice(index, 1);
    else selectedYears.push(year);
    
    updateYearButtons();
    updateCalendarForSelectedYears();
    
    // Si todos los a√±os est√°n seleccionados, mostrar todas las noticias
    if (selectedYears.length === availableYears.length) {
        loadAllNews();
    } else {
        performSearch();
    }
}

function updateYearButtons() {
    const allBtn = document.querySelector('.year-btn.all-years');
    const noneBtn = document.querySelector('.year-btn.none-years');
    
    const allYearsSelected = selectedYears.length === availableYears.length;
    const noYearsSelected = selectedYears.length === 0;
    
    if (allBtn) {
        allBtn.classList.toggle('active', allYearsSelected);
    }
    if (noneBtn) {
        noneBtn.classList.toggle('active', noYearsSelected);
    }
    
    availableYears.forEach(year => {
        const btn = document.getElementById(`year-${year}`);
        if (btn) {
            btn.classList.toggle('active', selectedYears.includes(year));
        }
    });
    
    // Si todos los a√±os est√°n seleccionados y no hay b√∫squeda activa, mostrar todas las noticias
    if (allYearsSelected && !searchTerm.trim() && !selectedDay) {
        console.log('Todos los a√±os seleccionados - mostrando todas las noticias');
        loadAllNews();
    }
}

function updateCalendarForSelectedYears() {
    if (selectedYears.length === 0) {
        showNoYearsSelected();
        return;
    }
    if (!selectedYears.includes(currentCalendarYear)) {
        currentCalendarYear = Math.min(...selectedYears);
    }
    generateCalendar();
}

function showNoYearsSelected() {
    const calendarContainer = document.getElementById('calendarContainer');
    document.getElementById('currentYearSelector').innerHTML = '<span>Selecciona un a√±o</span>';
    document.getElementById('prevYearBtn').disabled = true;
    document.getElementById('nextYearBtn').disabled = true;
    calendarContainer.innerHTML = `<div class="no-results" style="grid-column: 1 / -1; padding: 40px 20px;">üìÖ<br>Selecciona al menos un a√±o para ver el calendario</div>`;
}

function changeYear(direction) {
    if (selectedYears.length === 0) return;
    const sortedSelectedYears = [...selectedYears].sort((a, b) => a - b);
    const currentIndex = sortedSelectedYears.indexOf(currentCalendarYear);
    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < sortedSelectedYears.length) {
        currentCalendarYear = sortedSelectedYears[newIndex];
        generateCalendar();
        if (!searchTerm && !selectedDay) {
            loadAllNews(); // Mostrar todas las noticias si no hay b√∫squeda ni d√≠a seleccionado
        }
    }
}

function extractDateFromPDF(pdfName) {
    const match = pdfName.match(/(\d{4})-(\d{2})-(\d{2})\.pdf$/);
    if (match) {
        const [, year, month, day] = match;
        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    }
    return null;
}

function getFirstPage(page) {
    const match = page.toString().split(/[-\s]+/)[0];
    return isNaN(parseInt(match)) ? 1 : parseInt(match);
}

function generateCalendar() {
    const calendarContainer = document.getElementById('calendarContainer');
    const yearSelectorContainer = document.getElementById('currentYearSelector');
    const prevBtn = document.getElementById('prevYearBtn');
    const nextBtn = document.getElementById('nextYearBtn');

    if (selectedYears.length === 0) {
        showNoYearsSelected();
        return;
    }

    if (!selectedYears.includes(currentCalendarYear)) {
        currentCalendarYear = selectedYears[0];
    }

    const sortedSelectedYears = [...selectedYears].sort((a, b) => a - b);
    const currentIndex = sortedSelectedYears.indexOf(currentCalendarYear);
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === sortedSelectedYears.length - 1;

    yearSelectorContainer.innerHTML = `
        <select id="yearSelector" style="padding: 5px; border: 1px solid #2a5298; border-radius: 5px; cursor: pointer; font-size: 1rem;">
            ${sortedSelectedYears.map(year => `<option value="${year}" ${year === currentCalendarYear ? 'selected' : ''}>${year}</option>`).join('')}
        </select>
    `;

    document.getElementById('yearSelector').addEventListener('change', (e) => {
        currentCalendarYear = parseInt(e.target.value);
        generateCalendar();
        if (!searchTerm && !selectedDay) {
            loadAllNews(); // Mostrar todas las noticias si no hay b√∫squeda ni d√≠a seleccionado
        }
    });

    const yearData = allData.find(data => parseInt(data.A√±o) === currentCalendarYear);
    const newsByDay = {}; // { 0: { 15: { count: 5, ejemplares: [] } } }

    if (yearData) {
        const searchTermsArray = searchTerm.trim() ? searchTerm.split(/\s+/).filter(Boolean) : null;
        
        // Manejar tanto la estructura con ejemplares como items individuales
        const ejemplares = yearData.ejemplares || [yearData];
        
        ejemplares.forEach(ejemplar => {
            const pdfDate = extractDateFromPDF(ejemplar.PDF);
            if (!pdfDate) return;
            const month = pdfDate.getMonth();
            const day = pdfDate.getDate();
            const noticiasArray = ejemplar.noticias_musicales || [];
            const matchingNews = searchTermsArray 
                ? noticiasArray.filter(noticia => matchesSearch(noticia.texto_completo, searchTermsArray))
                : noticiasArray;
            if (matchingNews.length > 0) {
                if (!newsByDay[month]) newsByDay[month] = {};
                if (!newsByDay[month][day]) newsByDay[month][day] = { count: 0, ejemplares: [] };
                newsByDay[month][day].count += matchingNews.length;
                const filteredEjemplar = { ...ejemplar, noticias_musicales: matchingNews };
                newsByDay[month][day].ejemplares.push(filteredEjemplar);
            }
        });
    }

    calendarContainer.innerHTML = '';
    calendarContainer.className = 'calendar-container-annual';

    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const dayHeadersHTML = ['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(d => `<div class="calendar-day-header">${d}</div>`).join('');

    for (let month = 0; month < 12; month++) {
        const monthWrapper = document.createElement('div');
        monthWrapper.className = 'month-wrapper';
        let monthHTML = `<h4 class="month-title">${monthNames[month]}</h4><div class="calendar-grid">${dayHeadersHTML}`;

        const daysInMonth = new Date(currentCalendarYear, month + 1, 0).getDate();
        const firstDayOfWeek = new Date(currentCalendarYear, month, 1).getDay();
        const startDay = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        for (let i = 0; i < startDay; i++) monthHTML += `<div class="calendar-day other-month"></div>`;

        for (let day = 1; day <= daysInMonth; day++) {
            const dayData = newsByDay[month] && newsByDay[month][day];
            if (dayData) {
                monthHTML += `<div class="calendar-day has-news" onclick='selectDay(${currentCalendarYear}, ${month}, ${day}, ${JSON.stringify(dayData.ejemplares)})' title="${dayData.count} noticia(s)">
                                ${day}<div class="news-count">${dayData.count}</div>
                              </div>`;
            } else {
                monthHTML += `<div class="calendar-day">${day}</div>`;
            }
        }

        monthHTML += `</div>`;
        monthWrapper.innerHTML = monthHTML;
        calendarContainer.appendChild(monthWrapper);
    }
}

function selectDay(year, month, day, ejemplares) {
    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));

    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const monthContainer = Array.from(document.querySelectorAll('.month-title')).find(el => el.textContent === monthNames[month]);
    if (monthContainer) {
        const dayElement = Array.from(monthContainer.nextElementSibling.querySelectorAll('.calendar-day')).find(d => parseInt(d.textContent) === day);
        if (dayElement) dayElement.classList.add('selected');
    }

    selectedDay = { year, month, day };
    
    // Limpiar b√∫squeda cuando se selecciona un d√≠a
    searchTerm = '';
    document.getElementById('searchInput').value = '';
    
    currentResults = [];
    ejemplares.forEach(ejemplar => {
        ejemplar.noticias_musicales?.forEach(noticia => {
            currentResults.push({
                ...noticia,
                fecha_periodico: ejemplar.fecha_periodico,
                PDF: ejemplar.PDF,
                a√±o: year,
                searchTerms: []
            });
        });
    });

    displayResults();
    updateStats();

    const monthName = monthNames[month];
    const baseTitle = `Noticias del ${day} de ${monthName} de ${year}`;
    document.getElementById('resultsTitle').textContent = baseTitle;
}

function normalizeText(text) {
    return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function matchesSearch(text, searchTerms) {
    const normalizedText = normalizeText(text);
    return searchTerms.every(term => normalizedText.includes(normalizeText(term)));
}

function reorganizeDataByYear() {
    console.log('Reorganizando datos por a√±o...');
    console.log('Estructura original de allData:', allData);
    
    // Tu estructura espec√≠fica: array con un objeto que contiene ejemplares
    if (allData.length > 0 && allData[0].ejemplares) {
        console.log('Detectada estructura con ejemplares, reorganizando por a√±o...');
        
        const dataByYear = {};
        
        // Procesar cada item del array principal
        allData.forEach(item => {
            if (item.ejemplares && Array.isArray(item.ejemplares)) {
                item.ejemplares.forEach(ejemplar => {
                    // Extraer a√±o del nombre del PDF
                    const match = ejemplar.PDF?.match(/(\d{4})-\d{2}-\d{2}\.pdf$/);
                    if (match) {
                        const year = parseInt(match[1]);
                        
                        if (!dataByYear[year]) {
                            dataByYear[year] = { 
                                A√±o: year, 
                                ejemplares: [] 
                            };
                        }
                        
                        dataByYear[year].ejemplares.push(ejemplar);
                        console.log(`Agregado ejemplar ${ejemplar.PDF} al a√±o ${year}`);
                    }
                });
            }
        });
        
        // Convertir a array organizado por a√±os
        allData = Object.values(dataByYear);
        console.log('Datos reorganizados por a√±o:', allData);
        console.log('A√±os encontrados:', Object.keys(dataByYear));
        
        return;
    }
    
    console.log('Los datos ya est√°n organizados correctamente o tienen estructura diferente');
}

function performSearch() {
    console.log('Realizando b√∫squeda...');
    console.log('T√©rmino de b√∫squeda:', searchTerm);
    console.log('A√±os seleccionados:', selectedYears);
    
    // Si hay un d√≠a seleccionado y no hay b√∫squeda, mostrar solo ese d√≠a
    if (selectedDay && !searchTerm.trim()) {
        console.log('Mostrando d√≠a seleccionado');
        displayResults();
        updateStats();
        generateCalendar();
        return;
    }
    
    // Si no hay b√∫squeda y todos los a√±os est√°n seleccionados, mostrar todas las noticias
    if (!searchTerm.trim() && selectedYears.length === availableYears.length) {
        console.log('Mostrando todas las noticias (todos los a√±os seleccionados)');
        loadAllNews();
        generateCalendar();
        return;
    }
    
    // Si hay b√∫squeda, limpiar selecci√≥n de d√≠a y buscar en todo
    const searchTermsArray = searchTerm.trim() ? searchTerm.split(/\s+/).filter(Boolean) : null;
    currentResults = [];
    
    console.log('Procesando b√∫squeda o filtros espec√≠ficos...');
    
    allData.forEach(yearData => {
        const yearValue = parseInt(yearData.A√±o);
        if (!selectedYears.includes(yearValue)) {
            console.log(`Saltando a√±o ${yearValue} (no seleccionado)`);
            return;
        }
        
        console.log(`Procesando a√±o ${yearValue}`);
        
        // Manejar tanto la estructura con ejemplares como items individuales
        const ejemplares = yearData.ejemplares || [yearData];
        
        ejemplares.forEach(ejemplar => {
            const noticiasArray = ejemplar.noticias_musicales || [];
            noticiasArray.forEach(noticia => {
                if (!searchTermsArray || matchesSearch(noticia.texto_completo, searchTermsArray)) {
                    currentResults.push({
                        ...noticia,
                        fecha_periodico: ejemplar.fecha_periodico,
                        PDF: ejemplar.PDF,
                        a√±o: yearData.A√±o,
                        searchTerms: searchTermsArray || []
                    });
                }
            });
        });
    });
    
    console.log(`Total de resultados encontrados: ${currentResults.length}`);
    
    displayResults();
    updateStats();
    generateCalendar();
    
    // Actualizar t√≠tulo seg√∫n el contexto
    let title;
    if (searchTerm) {
        title = `Resultados de b√∫squeda: "${searchTerm}"`;
    } else if (selectedYears.length === availableYears.length) {
        title = 'Todas las Noticias';
    } else if (selectedYears.length === 1) {
        title = `Noticias de ${selectedYears[0]}`;
    } else {
        title = `Noticias de ${selectedYears.length} a√±os seleccionados`;
    }
    
    document.getElementById('resultsTitle').textContent = title;
}

function loadAllNews() {
    console.log('=== INICIANDO CARGA DE TODAS LAS NOTICIAS ===');
    console.log('A√±os seleccionados:', selectedYears);
    console.log('Estructura de allData:', allData);
    console.log('Cantidad de elementos en allData:', allData.length);
    
    currentResults = [];
    
    if (!allData || allData.length === 0) {
        console.error('allData est√° vac√≠o o no existe');
        displayResults();
        updateStats();
        return;
    }
    
    // Recopilar todas las noticias de todos los a√±os seleccionados
    allData.forEach((yearData, index) => {
        console.log(`\n--- Procesando elemento ${index} ---`);
        console.log('Datos del a√±o:', yearData);
        
        const yearValue = parseInt(yearData.A√±o);
        console.log('A√±o extra√≠do:', yearValue);
        
        if (!selectedYears.includes(yearValue)) {
            console.log(`Saltando a√±o ${yearValue} (no seleccionado)`);
            return;
        }
        
        console.log(`‚úì Procesando a√±o ${yearValue} (seleccionado)`);
        
        const ejemplares = yearData.ejemplares || [yearData];
        console.log('Ejemplares encontrados:', ejemplares.length);
        
        ejemplares.forEach((ejemplar, ejIndex) => {
            console.log(`  Ejemplar ${ejIndex}:`, {
                PDF: ejemplar.PDF,
                fecha: ejemplar.fecha_periodico,
                noticias: ejemplar.noticias_musicales?.length || 0
            });
            
            const noticiasArray = ejemplar.noticias_musicales || [];
            
            if (noticiasArray.length === 0) {
                console.log('    No hay noticias musicales en este ejemplar');
                return;
            }
            
            noticiasArray.forEach((noticia, notIndex) => {
                console.log(`    Agregando noticia ${notIndex}:`, {
                    texto: noticia.texto_completo?.substring(0, 50) + '...',
                    pagina: noticia.pagina
                });
                
                currentResults.push({
                    ...noticia,
                    fecha_periodico: ejemplar.fecha_periodico,
                    PDF: ejemplar.PDF,
                    a√±o: yearData.A√±o,
                    searchTerms: []
                });
            });
        });
    });
    
    console.log(`\n=== RESUMEN ===`);
    console.log(`Total de noticias cargadas: ${currentResults.length}`);
    console.log('Primeras 3 noticias:', currentResults.slice(0, 3));
    
    // Ordenar por fecha (m√°s recientes primero o por orden cronol√≥gico)
    currentResults.sort((a, b) => {
        const dateA = extractDateFromPDF(a.PDF);
        const dateB = extractDateFromPDF(b.PDF);
        if (dateA && dateB) {
            return dateA - dateB; // Orden cronol√≥gico (m√°s antiguas primero)
        }
        return 0;
    });
    
    // Mostrar todas las noticias
    displayResults();
    updateStats();
    
    // Establecer t√≠tulo por defecto
    document.getElementById('resultsTitle').textContent = 'Todas las Noticias';
}

function displayAllResults() {
    console.log('Mostrando todos los resultados');
    searchTerm = '';
    selectedDay = null;
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
    
    // Usar la nueva funci√≥n para cargar todas las noticias
    loadAllNews();
}

function displayResults() {
    const resultsContainer = document.getElementById('results');
    const resultsCount = document.getElementById('resultsCount');

    console.log(`Mostrando ${currentResults.length} resultados`);

    if (currentResults.length === 0) {
        resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon">üì∞</div><h3>No se encontraron resultados</h3><p>Intenta con otros t√©rminos de b√∫squeda, selecciona diferentes a√±os, o navega por el calendario</p></div>`;
        resultsCount.textContent = 'Sin resultados';
        return;
    }

    const groupedResults = {};
    currentResults.forEach(result => {
        if (!groupedResults[result.PDF]) {
            groupedResults[result.PDF] = { a√±o: result.a√±o, fecha: result.fecha_periodico, pdf: result.PDF, pdfDate: extractDateFromPDF(result.PDF), noticias: [] };
        }
        groupedResults[result.PDF].noticias.push(result);
    });

    const sortedGroups = Object.values(groupedResults).sort((a, b) => (a.pdfDate && b.pdfDate) ? a.pdfDate - b.pdfDate : b.a√±o - a.a√±o);

    let html = '';
    sortedGroups.forEach(group => {
        const displayDate = group.pdfDate ? group.pdfDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : `${group.fecha} (${group.a√±o})`;
        html += `
            <div class="result-item">
                <div class="result-header">
                    <div class="result-date">${displayDate}</div>
                    <div class="result-meta">${group.noticias.length} noticia${group.noticias.length > 1 ? 's' : ''}</div>
                </div>
                <div class="result-content">
                    ${group.noticias.map(noticia => {
                        const firstPage = getFirstPage(noticia.pagina);
                        return `
                            <div class="news-item">
                                <div class="news-text">${highlightText(noticia.texto_completo, noticia.searchTerms)}</div>
                                <div class="news-page">
                                    <a href="${noticia.PDF}#page=${firstPage}" target="_blank">P√°gina ${firstPage}</a>
                                </div>
                            </div>`;
                    }).join('')}
                </div>
            </div>`;
    });

    resultsContainer.innerHTML = html;
    
    let countText;
    if (selectedYears.length === availableYears.length) {
        countText = `${currentResults.length} noticia${currentResults.length > 1 ? 's' : ''} encontrada${currentResults.length > 1 ? 's' : ''} en total`;
    } else {
        countText = `${currentResults.length} noticia${currentResults.length > 1 ? 's' : ''} encontrada${currentResults.length > 1 ? 's' : ''} en ${selectedYears.length} a√±o${selectedYears.length > 1 ? 's' : ''}`;
    }
    
    resultsCount.textContent = countText;
}

function highlightText(text, searchTerms) {
    if (!searchTerms || searchTerms.length === 0) return text;
    let highlightedText = text;
    const normalizedText = normalizeText(text);
    searchTerms.forEach(term => {
        const normalizedTerm = normalizeText(term);
        if (normalizedTerm.length === 0) return;
        const regex = new RegExp(normalizedTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        let match;
        while ((match = regex.exec(normalizedText)) !== null) {
            const originalWord = text.substring(match.index, match.index + match[0].length);
            highlightedText = highlightedText.split(originalWord).join(`<span class="highlight">${originalWord}</span>`);
        }
    });
    return highlightedText;
}

function updateStats() {
    let totalDaysInSelected = 0, totalNewsInSelected = 0;
    allData.forEach(yearData => {
        if (selectedYears.includes(parseInt(yearData.A√±o))) {
            // Manejar tanto la estructura con ejemplares como items individuales
            const ejemplares = yearData.ejemplares || [yearData];
            totalDaysInSelected += ejemplares.length;
            totalNewsInSelected += ejemplares.reduce((sum, ej) => {
                return sum + (ej.total_noticias || ej.noticias_musicales?.length || 0);
            }, 0);
        }
    });
    const uniqueDates = new Set(currentResults.map(r => r.PDF));
    document.getElementById('totalDays').textContent = totalDaysInSelected;
    document.getElementById('totalNews').textContent = totalNewsInSelected;
    document.getElementById('filteredDays').textContent = uniqueDates.size;
    document.getElementById('filteredNews').textContent = currentResults.length;
}

function clearSearch() {
    console.log('Limpiando b√∫squeda y filtros');
    selectedDay = null;
    searchTerm = '';
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
    
    // Restaurar todos los a√±os como seleccionados
    if (selectedYears.length !== availableYears.length) {
        selectedYears = [...availableYears];
        updateYearButtons();
        updateCalendarForSelectedYears();
    }
    
    // Cargar todas las noticias
    loadAllNews();
}
</script>
</body>
</html>
